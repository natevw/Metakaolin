function pathToTree(e){for(var t,n=[e.shift(),[]],r=n;e.length;)t=[e.shift(),[]],r[1].push(t),r=t;return n}function mergeTree(e,t){for(var n=[{tree1:e,tree2:t}],r=!1;n.length>0;)for(var o=n.pop(),a=o.tree1,i=o.tree2,s=0;i[1].length>s;s++)if(a[1][0]){for(var c=!1,u=0;a[1].length>u;u++)a[1][u][0]===i[1][s][0]&&(n.push({tree1:a[1][u],tree2:i[1][s]}),c=!0);c||(r="new_branch",a[1].push(i[1][s]),a[1].sort())}else r="new_leaf",a[1][0]=i[1][s];return{conflicts:r,tree:e}}function doMerge(e,t,n){var r,o=[],a=!1,i=!1;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])r=mergeTree(e.ids,t.ids),o.push({pos:e.pos,ids:r.tree}),a=a||r.conflicts,i=!0;else if(n!==!0){var s=e.pos<t.pos?e:t,c=e.pos<t.pos?t:e,u=c.pos-s.pos,l=[],d=[];for(d.push({ids:s.ids,diff:u,parent:null,parentIdx:null});d.length>0;){var f=d.pop();0!==f.diff?f.ids&&f.ids[1].forEach(function(e,t){d.push({ids:e,diff:f.diff-1,parent:f.ids,parentIdx:t})}):f.ids[0]===c.ids[0]&&l.push(f)}var p=l[0];p?(r=mergeTree(p.ids,c.ids),p.parent[1][p.parentIdx]=r.tree,o.push({pos:s.pos,ids:s.ids}),a=a||r.conflicts,i=!0):o.push(e)}else o.push(e)}),i||o.push(t),o.sort(function(e,t){return e.pos-t.pos}),{tree:o,conflicts:a||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}function stem(e,t){var n=rootToLeaf(e).map(function(e){var n=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-n.length),ids:pathToTree(n)}});return n.reduce(function(e,t){return doMerge(e,t,!0).tree},[n.shift()])}function replicate(e,t,n,r,o){fetchCheckpoint(e,t,n,function(a){function i(){c&&0===u&&(f.end_time=new Date,writeCheckpoint(e,t,n,l,function(){call(r,null,f)}))}var s=[],c=!1,u=0,l=a,d=n.continuous||!1,f={ok:!0,start_time:new Date,docs_read:0,docs_written:0};if(!o.cancelled){var p={continuous:d,since:a,style:"all_docs",onChange:function(a){l=a.seq,s.push(a),f.docs_read++,u++;var c={};c[a.id]=a.changes.map(function(e){return e.rev}),t.revsDiff(c,function(a,s){if(a)return d&&o.cancel(),call(r,a,null),void 0;if(0===Object.keys(s).length)return u--,i(),void 0;for(var c in s)s[c].missing.map(function(r){e.get(c,{revs:!0,rev:r,attachments:!0},function(e,r){t.bulkDocs({docs:[r]},{new_edits:!1},function(){n.onChange&&n.onChange.apply(this,[f]),f.docs_written++,u--,i()})})})})},complete:function(){c=!0,i()}};n.filter&&(p.filter=n.filter),n.query_params&&(p.query_params=n.query_params);var h=e.changes(p);n.continuous&&(o.cancel=h.cancel)}})}function toPouch(e,t){return"string"==typeof e?new Pouch(e,t):(t(null,e),void 0)}function parseUri(e){for(var t=parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},o=14;o--;)r[t.key[o]]=n[o]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,o){n&&(r[t.q.name][n]=o)}),r}function getHost(e){if(/http(s?):/.test(e)){var t=parseUri(e);t.remote=!0,(t.user||t.password)&&(t.auth={username:t.user,password:t.password});var n=t.path.replace(/(^\/|\/$)/g,"").split("/");return t.db=n.pop(),t.path=n.join("/"),t}return{host:"",path:"/",db:e,auth:!1}}function genDBUrl(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+e.db+"/"+t}return"/"+e.db+"/"+t}function genUrl(e,t){return e.remote?e.protocol+"://"+e.host+":"+e.port+"/"+t:"/"+t}function quote(e){return"'"+e+"'"}(function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var r=e,o=[];if(n=n||r.length,t)for(var a=0;t>a;a++)o[a]=r[0|Math.random()*n];else{var i;o[8]=o[13]=o[18]=o[23]="-",o[14]="4";for(var a=0;36>a;a++)o[a]||(i=0|16*Math.random(),o[a]=r[19==a?8|3&i:i])}return o.join("")},Math.uuidFast=function(){for(var t,n=e,r=Array(36),o=0,a=0;36>a;a++)8==a||13==a||18==a||23==a?r[a]="-":14==a?r[a]="4":(2>=o&&(o=0|33554432+16777216*Math.random()),t=15&o,o>>=4,r[a]=n[19==a?8|3&t:t]);return r.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),n="x"==e?t:8|3&t;return n.toString(16)}).toUpperCase()}})();var Crypto={};(function(){Crypto.MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,o,a,i;return o=2147483648&e,a=2147483648&t,n=1073741824&e,r=1073741824&t,i=(1073741823&e)+(1073741823&t),n&r?2147483648^i^o^a:n|r?1073741824&i?3221225472^i^o^a:1073741824^i^o^a:i^o^a}function r(e,t,n){return e&t|~e&n}function o(e,t,n){return e&n|t&~n}function a(e,t,n){return e^t^n}function i(e,t,n){return t^(e|~n)}function s(e,o,a,i,s,c,u){return e=n(e,n(n(r(o,a,i),s),u)),n(t(e,c),o)}function c(e,r,a,i,s,c,u){return e=n(e,n(n(o(r,a,i),s),u)),n(t(e,c),r)}function u(e,r,o,i,s,c,u){return e=n(e,n(n(a(r,o,i),s),u)),n(t(e,c),r)}function l(e,r,o,a,s,c,u){return e=n(e,n(n(i(r,o,a),s),u)),n(t(e,c),r)}function d(e){for(var t,n=e.length,r=n+8,o=(r-r%64)/64,a=16*(o+1),i=Array(a-1),s=0,c=0;n>c;)t=(c-c%4)/4,s=8*(c%4),i[t]=i[t]|e.charCodeAt(c)<<s,c++;return t=(c-c%4)/4,s=8*(c%4),i[t]=i[t]|128<<s,i[a-2]=n<<3,i[a-1]=n>>>29,i}function f(e){var t,n,r="",o="";for(n=0;3>=n;n++)t=255&e>>>8*n,o="0"+t.toString(16),r+=o.substr(o.length-2,2);return r}var p,h,_,v,m,g,E,y,S,O=[],T=7,R=12,b=17,C=22,w=5,D=9,I=14,P=20,q=4,k=11,x=16,j=23,A=6,N=10,B=15,U=21;for(O=d(e),g=1732584193,E=4023233417,y=2562383102,S=271733878,p=0;O.length>p;p+=16)h=g,_=E,v=y,m=S,g=s(g,E,y,S,O[p+0],T,3614090360),S=s(S,g,E,y,O[p+1],R,3905402710),y=s(y,S,g,E,O[p+2],b,606105819),E=s(E,y,S,g,O[p+3],C,3250441966),g=s(g,E,y,S,O[p+4],T,4118548399),S=s(S,g,E,y,O[p+5],R,1200080426),y=s(y,S,g,E,O[p+6],b,2821735955),E=s(E,y,S,g,O[p+7],C,4249261313),g=s(g,E,y,S,O[p+8],T,1770035416),S=s(S,g,E,y,O[p+9],R,2336552879),y=s(y,S,g,E,O[p+10],b,4294925233),E=s(E,y,S,g,O[p+11],C,2304563134),g=s(g,E,y,S,O[p+12],T,1804603682),S=s(S,g,E,y,O[p+13],R,4254626195),y=s(y,S,g,E,O[p+14],b,2792965006),E=s(E,y,S,g,O[p+15],C,1236535329),g=c(g,E,y,S,O[p+1],w,4129170786),S=c(S,g,E,y,O[p+6],D,3225465664),y=c(y,S,g,E,O[p+11],I,643717713),E=c(E,y,S,g,O[p+0],P,3921069994),g=c(g,E,y,S,O[p+5],w,3593408605),S=c(S,g,E,y,O[p+10],D,38016083),y=c(y,S,g,E,O[p+15],I,3634488961),E=c(E,y,S,g,O[p+4],P,3889429448),g=c(g,E,y,S,O[p+9],w,568446438),S=c(S,g,E,y,O[p+14],D,3275163606),y=c(y,S,g,E,O[p+3],I,4107603335),E=c(E,y,S,g,O[p+8],P,1163531501),g=c(g,E,y,S,O[p+13],w,2850285829),S=c(S,g,E,y,O[p+2],D,4243563512),y=c(y,S,g,E,O[p+7],I,1735328473),E=c(E,y,S,g,O[p+12],P,2368359562),g=u(g,E,y,S,O[p+5],q,4294588738),S=u(S,g,E,y,O[p+8],k,2272392833),y=u(y,S,g,E,O[p+11],x,1839030562),E=u(E,y,S,g,O[p+14],j,4259657740),g=u(g,E,y,S,O[p+1],q,2763975236),S=u(S,g,E,y,O[p+4],k,1272893353),y=u(y,S,g,E,O[p+7],x,4139469664),E=u(E,y,S,g,O[p+10],j,3200236656),g=u(g,E,y,S,O[p+13],q,681279174),S=u(S,g,E,y,O[p+0],k,3936430074),y=u(y,S,g,E,O[p+3],x,3572445317),E=u(E,y,S,g,O[p+6],j,76029189),g=u(g,E,y,S,O[p+9],q,3654602809),S=u(S,g,E,y,O[p+12],k,3873151461),y=u(y,S,g,E,O[p+15],x,530742520),E=u(E,y,S,g,O[p+2],j,3299628645),g=l(g,E,y,S,O[p+0],A,4096336452),S=l(S,g,E,y,O[p+7],N,1126891415),y=l(y,S,g,E,O[p+14],B,2878612391),E=l(E,y,S,g,O[p+5],U,4237533241),g=l(g,E,y,S,O[p+12],A,1700485571),S=l(S,g,E,y,O[p+3],N,2399980690),y=l(y,S,g,E,O[p+10],B,4293915773),E=l(E,y,S,g,O[p+1],U,2240044497),g=l(g,E,y,S,O[p+8],A,1873313359),S=l(S,g,E,y,O[p+15],N,4264355552),y=l(y,S,g,E,O[p+6],B,2734768916),E=l(E,y,S,g,O[p+13],U,1309151649),g=l(g,E,y,S,O[p+4],A,4149444226),S=l(S,g,E,y,O[p+11],N,3174756917),y=l(y,S,g,E,O[p+2],B,718787259),E=l(E,y,S,g,O[p+9],U,3951481745),g=n(g,h),E=n(E,_),y=n(y,v),S=n(S,m);var L=f(g)+f(E)+f(y)+f(S);return L.toLowerCase()}})(),function(){if(!Object.defineProperty||!function(){try{return Object.defineProperty({},"x",{}),!0}catch(e){return!1}}()){var e=Object.defineProperty;Object.defineProperty=function(t,n,r){"use strict";if(e)try{return e(t,n,r)}catch(o){}if(t!==Object(t))throw new TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in r&&Object.prototype.__defineGetter__.call(t,n,r.get),Object.prototype.__defineSetter__&&"set"in r&&Object.prototype.__defineSetter__.call(t,n,r.set),"value"in r&&(t[n]=r.value),t}}}(),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return n}),Array.prototype.forEach||(Array.prototype.forEach=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;var r,o=arguments[1];for(r=0;n>r;r++)r in t&&e.call(o,t[r],r,t)}),Array.prototype.map||(Array.prototype.map=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;var r=[];r.length=n;var o,a=arguments[1];for(o=0;n>o;o++)o in t&&(r[o]=e.call(a,t[o],o,t));return r});var Pouch=function Pouch(e,t,n){if(!(this instanceof Pouch))return new Pouch(e,t,n);("function"==typeof t||t===void 0)&&(n=t,t={}),"object"==typeof e&&(t=e,e=void 0);var r=Pouch.parseAdapter(t.name||e);if(t.name=t.name||r.name,t.adapter=t.adapter||r.adapter,!Pouch.adapters[t.adapter])throw"Adapter is missing";if(!Pouch.adapters[t.adapter].valid())throw"Invalid Adapter";var o=new PouchAdapter(t,function(e,t){if(e)return n&&n(e),void 0;for(var r in Pouch.plugins){var o=Pouch.plugins[r](t);for(var a in o)a in t||(t[a]=o[a])}n(null,t)});for(var a in o)this[a]=o[a]};if(Pouch.DEBUG=!1,Pouch.adapters={},Pouch.plugins={},Pouch.parseAdapter=function(e){var t=e.match(/([a-z\-]*):\/\/(.*)/);if(t){e=/http(s?)/.test(t[1])?t[1]+"://"+t[2]:t[2];var n=t[1];if(!Pouch.adapters[n].valid())throw"Invalid adapter";return{name:e,adapter:t[1]}}var r={idb:1,leveldb:2,websql:3,http:4,https:4},o=Object.keys(Pouch.adapters).sort(function(e,t){return r[e]-r[t]})[0];return{name:e,adapter:o}},Pouch.destroy=function(e,t){for(var n in Pouch.plugins)Pouch.plugins[n]._delete(e);var r=Pouch.parseAdapter(e);Pouch.adapters[r.adapter].destroy(r.name,t)},Pouch.adapter=function(e,t){t.valid()&&(Pouch.adapters[e]=t)},Pouch.plugin=function(e,t){Pouch.plugins[e]=t},Pouch.Errors={MISSING_BULK_DOCS:{status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"},MISSING_DOC:{status:404,error:"not_found",reason:"missing"},REV_CONFLICT:{status:409,error:"conflict",reason:"Document update conflict"},INVALID_ID:{status:400,error:"invalid_id",reason:"_id field must contain a string"},MISSING_ID:{status:412,error:"missing_id",reason:"_id is required for puts"},RESERVED_ID:{status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."},NOT_OPEN:{status:412,error:"precondition_failed",reason:"Database not open so cannot close"},UNKNOWN_ERROR:{status:500,error:"unknown_error",reason:"Database encountered an unknown error"},INVALID_REQUEST:{status:400,error:"invalid_request",reason:"Request was invalid"},QUERY_PARSE_ERROR:{status:400,error:"query_parse_error",reason:"Some query parameter is invalid"},BAD_REQUEST:{status:400,error:"bad_request",reason:"Something wrong with the request"}},"undefined"!=typeof module&&module.exports){global.Pouch=Pouch,Pouch.merge=require("./pouch.merge.js").merge,Pouch.collate=require("./pouch.collate.js").collate,Pouch.replicate=require("./pouch.replicate.js").replicate,Pouch.utils=require("./pouch.utils.js"),module.exports=Pouch;var PouchAdapter=require("./pouch.adapter.js"),adapters=["leveldb","http"];adapters.map(function(e){var t="./adapters/pouch."+e+".js";require(t)}),require("./plugins/pouchdb.mapreduce.js")}else window.Pouch=Pouch;"undefined"!=typeof module&&module.exports&&(module.exports=Pouch);var stringCollate=function(e,t){return e===t?0:e>t?1:-1},objectCollate=function(e,t){for(var n=Object.keys(e),r=Object.keys(t),o=Math.min(n.length,r.length),a=0;o>a;a++){var i=Pouch.collate(n[a],r[a]);if(0!==i)return i;if(i=Pouch.collate(e[n[a]],t[r[a]]),0!==i)return i}return n.length===r.length?0:n.length>r.length?1:-1},arrayCollate=function(e,t){for(var n=Math.min(e.length,t.length),r=0;n>r;r++){var o=Pouch.collate(e[r],t[r]);if(0!==o)return o}return e.length===t.length?0:e.length>t.length?1:-1},collationIndex=function(e){var t=["boolean","number","string","object"];return-1!==t.indexOf(typeof e)?null===e?1:t.indexOf(typeof e)+2:Array.isArray(e)?4.5:void 0};if(Pouch.collate=function(e,t){var n=collationIndex(e),r=collationIndex(t);return 0!==n-r?n-r:null===e?0:"number"==typeof e?e-t:"boolean"==typeof e?t>e?-1:1:"string"==typeof e?stringCollate(e,t):Array.isArray(e)?arrayCollate(e,t):"object"==typeof e?objectCollate(e,t):void 0},"undefined"!=typeof module&&module.exports){module.exports=Pouch;var utils=require("./pouch.utils.js");for(var k in utils)global[k]=utils[k]}Pouch.merge=function(e,t,n){e=extend(!0,[],e),t=extend(!0,{},t);var r=doMerge(e,t);return{tree:stem(r.tree,n),conflicts:r.conflicts}},Pouch.merge.winningRev=function(e){var t=e.deletions||{},n=[];return traverseRevTree(e.rev_tree,function(e,t,r){e&&n.push({pos:t,id:r})}),n.forEach(function(e){e.deleted=e.id in t}),n.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),n[0].pos+"-"+n[0].id},"undefined"!=typeof module&&module.exports&&(module.exports=Pouch),Pouch.replicate=function(e,t,n,r){n instanceof Function&&(r=n,n={}),void 0===n&&(n={});var o=function(){this.cancelled=!1,this.cancel=function(){this.cancelled=!0}},a=new o;return toPouch(e,function(e,o){return e?call(r,e):(toPouch(t,function(e,t){return e?call(r,e):(replicate(o,t,n,r,a),void 0)}),void 0)}),a};for(var call=function(e){var t=Array.prototype.slice.call(arguments,1);typeof e==typeof Function&&e.apply(this,t)},yankError=function(e){return function(t,n){t||n[0].error?call(e,t||n[0]):call(e,null,n[0])}},isLocalId=function(e){return/^_local/.test(e)},isAttachmentId=function(e){return/\//.test(e)&&!isLocalId(e)&&!/^_design/.test(e)},parseDocId=function(e){var t="string"!=typeof e||/^_(design|local)\//.test(e)?[e]:e.split("/");return{docId:t[0],attachmentId:t.splice(1).join("/").replace(/^\/+/,"")}},isDeleted=function(e,t){return e&&e.deletions?(t||(t=Pouch.merge.winningRev(e)),t.indexOf("-")>=0&&(t=t.split("-")[1]),e.deletions[t]===!0):!1},isValidId=function(e){return/^_/.test(e)?/^_(design|local)/.test(e):!0},parseDoc=function(e,t){var n=null;if(e._id){var r=parseDocId(e._id);if(""!==r.attachmentId){var o=btoa(JSON.stringify(e));e={_id:r.docId},e._attachments||(e._attachments={}),e._attachments[r.attachmentId]={content_type:"application/json",data:o}}}var a,i,s;if(t)if(e._id||(e._id=Math.uuid()),i=Math.uuid(32,16).toLowerCase(),e._rev){if(s=/^(\d+)-(.+)$/.exec(e._rev),!s)throw"invalid value for property '_rev'";e._rev_tree=[{pos:parseInt(s[1],10),ids:[s[2],[[i,[]]]]}],a=parseInt(s[1],10)+1}else e._rev_tree=[{pos:1,ids:[i,[]]}],a=1;else e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return null===e?[t,[]]:[t,[e]]},null)}],a=e._revisions.start,i=e._revisions.ids[0]),e._rev_tree||(s=/^(\d+)-(.+)$/.exec(e._rev),a=parseInt(s[1],10),i=s[2],e._rev_tree=[{pos:parseInt(s[1],10),ids:[s[2],[]]}]);return"string"!=typeof e._id?n=Pouch.Errors.INVALID_ID:isValidId(e._id)||(n=Pouch.Errors.RESERVED_ID),e._id=decodeURIComponent(e._id),e._rev=[a,i].join("-"),n?n:Object.keys(e).reduce(function(t,n){return/^_/.test(n)&&"_attachments"!==n?t.metadata[n.slice(1)]=e[n]:t.data[n]=e[n],t},{metadata:{},data:{}})},compareRevs=function(e,t){return e.id!==t.id?e.id<t.id?-1:1:e.deleted^t.deleted?e.deleted?-1:1:e.rev_tree[0].pos===t.rev_tree[0].pos?e.rev_tree[0].ids<t.rev_tree[0].ids?-1:1:e.rev_tree[0].start<t.rev_tree[0].start?-1:1},traverseRevTree=function(e,t){var n=[];for(e.forEach(function(e){n.push({pos:e.pos,ids:e.ids})});n.length>0;){var r=n.pop(),o=r.pos,a=r.ids,i=t(0===a[1].length,o,a[0],r.ctx);a[1].forEach(function(e){n.push({pos:o+1,ids:e,ctx:i})})}},collectRevs=function(e){var t=[];return traverseRevTree([e],function(e,n,r){t.push({rev:n+"-"+r,status:"available"})}),t},collectLeaves=function(e){var t=[];return traverseRevTree(e,function(e,n,r){e&&t.unshift({rev:n+"-"+r,pos:n})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},collectConflicts=function(e,t){for(var n=collectLeaves(e),r=0;n.length>r;r++){var o=n.shift(),a=o.rev.split("-")[1];t&&!t[a]&&n.push(o)}return n.shift(),n.map(function(e){return e.rev})},fetchCheckpoint=function(e,t,n,r){var o="";n.filter!==void 0&&(o=""+n.filter);var a=Crypto.MD5(e.id()+t.id()+o);e.get("_local/"+a,function(e,t){e&&404===e.status?r(0):r(t.last_seq)})},writeCheckpoint=function(e,t,n,r,o){var a="";n.filter!==void 0&&(a=""+n.filter);var i={_id:"_local/"+Crypto.MD5(e.id()+t.id()+a),last_seq:r};e.get(i._id,function(t,n){n&&n._rev&&(i._rev=n._rev),e.put(i,function(){o()})})},arrayFirst=function(e,t){for(var n=0;e.length>n;n++)if(t(e[n],n)===!0)return e[n];return!1},filterChange=function(e){return function(t){(!e.filter||e.filter.call(this,t.doc))&&(e.include_docs||delete t.doc,call(e.onChange,t))}},rootToLeaf=function(e){var t=[];return traverseRevTree(e,function(e,n,r,o){if(o=o?o.slice(0):[],o.push(r),e){var a=n+1-o.length;t.unshift({pos:a,ids:o})}return o}),t},ajax=(function ajax(e,t){"function"==typeof e&&(t=e,e={});var n={method:"GET",headers:{},json:!0,timeout:1e4};if(e=extend(!0,n,e),e.auth){var r=btoa(e.auth.username+":"+e.auth.password);e.headers.Authorization="Basic "+r}var o=function(t,n,r){e.json||"string"==typeof t?e.json&&"string"==typeof t&&(t=JSON.parse(t)):t=JSON.stringify(t),call(r,null,t,n)},a=function(e,t){var n,r=e.responseText?{status:e.status}:e;try{n=JSON.parse(e.responseText),r=extend(!0,{},r,n)}catch(o){}call(t,r)};if("undefined"!=typeof window&&window.XMLHttpRequest){var i,s=!1,c=new XMLHttpRequest;c.open(e.method,e.url),e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]="application/json",e.body&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body)));for(var u in e.headers)c.setRequestHeader(u,e.headers[u]);"body"in e||(e.body=null);var l=function(){s=!0,c.abort(),call(a,c,t)};return c.onreadystatechange=function(){4!==c.readyState||s||(clearTimeout(i),c.status>=200&&300>c.status?call(o,c.responseText,c,t):call(a,c,t))},e.timeout>0&&(i=setTimeout(l,e.timeout)),c.send(e.body),{abort:l}}return e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]="application/json"),request(e,function(n,r,i){if(n)return n.status=r?r.statusCode:400,call(a,n,t);var s=r.headers["content-type"],c=i||"";e.json&&"object"!=typeof c&&(/json/.test(s)||/^[\s]*\{/.test(c)&&/\}[\s]*$/.test(c))&&(c=JSON.parse(c)),c.error?(c.status=r.statusCode,call(a,c,t)):call(o,c,r,t)})}),class2type={},types=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],i=0;types.length>i;i++){var typename=types[i];class2type["[object "+typename+"]"]=typename.toLowerCase()}var core_toString=class2type.toString,core_hasOwn=class2type.hasOwnProperty,type=function(e){return null===e?e+"":"object"==typeof e||"function"==typeof e?class2type[core_toString.call(e)]||"object":typeof e},isWindow=function(e){return null!==e&&e===e.window},isPlainObject=function(e){if(!e||"object"!==type(e)||e.nodeType||isWindow(e))return!1;try{if(e.constructor&&!core_hasOwn.call(e,"constructor")&&!core_hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n;for(n in e);return void 0===n||core_hasOwn.call(e,n)},isFunction=function(e){return"function"===type(e)},isArray=Array.isArray||function(e){return"array"===type(e)},extend=function(){var e,t,n,r,o,a,i=arguments[0]||{},s=1,c=arguments.length,u=!1;for("boolean"==typeof i&&(u=i,i=arguments[1]||{},s=2),"object"==typeof i||isFunction(i)||(i={}),c===s&&(i=this,--s);c>s;s++)if(null!=(e=arguments[s]))for(t in e)n=i[t],r=e[t],i!==r&&(u&&r&&(isPlainObject(r)||(o=isArray(r)))?(o?(o=!1,a=n&&isArray(n)?n:[]):a=n&&isPlainObject(n)?n:{},i[t]=extend(u,a,r)):void 0!==r&&(i[t]=r));return i},win=this,localJSON=function(){return win.localStorage?{set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},get:function(e,t){try{return null===localStorage.getItem(e)?t:JSON.parse(localStorage.getItem(e)||"false")}catch(n){return t}},remove:function(e){localStorage.removeItem(e)}}:!1}();if("undefined"!=typeof module&&module.exports){var crypto=require("crypto"),Crypto={MD5:function(e){return crypto.createHash("md5").update(e).digest("hex")}};request=require("request"),_=require("underscore"),$=_,module.exports={Crypto:Crypto,call:call,yankError:yankError,isLocalId:isLocalId,isAttachmentId:isAttachmentId,parseDocId:parseDocId,parseDoc:parseDoc,isDeleted:isDeleted,compareRevs:compareRevs,collectRevs:collectRevs,collectLeaves:collectLeaves,collectConflicts:collectConflicts,fetchCheckpoint:fetchCheckpoint,writeCheckpoint:writeCheckpoint,arrayFirst:arrayFirst,filterChange:filterChange,ajax:ajax,atob:function(e){return decodeURIComponent(escape(new Buffer(e,"base64").toString("binary")))},btoa:function(e){return new Buffer(unescape(encodeURIComponent(e)),"binary").toString("base64")},extend:extend,traverseRevTree:traverseRevTree,rootToLeaf:rootToLeaf,isPlainObject:isPlainObject,isArray:isArray}}var Changes=function(){var e={},t={};return window.addEventListener("storage",function(t){e.notify(t.key)}),e.addListener=function(e,n,r,o){t[e]||(t[e]={}),t[e][n]={db:r,opts:o}},e.removeListener=function(e,n){delete t[e][n]},e.clearListeners=function(e){delete t[e]},e.notify=function(e){if(t[e])for(var n in t[e]){var r=t[e][n].opts;t[e][n].db.changes({include_docs:r.include_docs,conflicts:r.conflicts,continuous:!1,filter:r.filter,since:r.since,onChange:function(e){e.seq>r.since&&(r.since=e.seq,call(r.onChange,e))}})}},e},PouchAdapter=function(e,t){var n={},r=Pouch.adapters[e.adapter](e,function(e,r){if(e)return t&&t(e),void 0;for(var o in n)r.hasOwnProperty(o)||(r[o]=n[o]);t(e,r)});n.post=function(e,t,n){return"function"==typeof t&&(n=t,t={}),r.bulkDocs({docs:[e]},t,yankError(n))},n.put=function(e,t,n){return"function"==typeof t&&(n=t,t={}),e&&"_id"in e?r.bulkDocs({docs:[e]},t,yankError(n)):call(n,Pouch.Errors.MISSING_ID)},n.putAttachment=n.putAttachment=function(e,t,r,o,a){e=parseDocId(e),n.get(e.docId,{attachments:!0},function(t,i){i._attachments=i._attachments||{},i._attachments[e.attachmentId]={content_type:o,data:btoa(r)},n.put(i,a)})},n.removeAttachment=function(e,t,r){e=parseDocId(e),n.get(e.docId,function(o,a){return o?(call(r,o),void 0):a._rev!==t?(call(r,Pouch.Errors.REV_CONFLICT),void 0):(a._attachments=a._attachments||{},delete a._attachments[e.attachmentId],n.put(a,r),void 0)})},n.remove=function(e,t,n){"function"==typeof t&&(n=t,t={}),void 0===t&&(t={}),t.was_delete=!0;var o=extend(!0,{},e);return o._deleted=!0,r.bulkDocs({docs:[o]},t,yankError(n))},n.revsDiff=function(e,t,r){function o(t,n,o){return e[o].map(function(e){var t=function(t){return t.rev!==e};(!n||n._revs_info.every(t))&&(s[o]||(s[o]={missing:[]}),s[o].missing.push(e))}),++i===a.length?call(r,null,s):void 0}"function"==typeof t&&(r=t,t={});var a=Object.keys(e),i=0,s={};a.map(function(e){n.get(e,{revs_info:!0},function(t,n){o(t,n,e)})})},n.get=function(e,t,n){return"function"==typeof t&&(n=t,t={}),e=parseDocId(e),""!==e.attachmentId?r.getAttachment(e,{decode:!0},n):r._get(e,t,n)},n.getAttachment=function(e,t,n){return t instanceof Function&&(n=t,t={}),"string"==typeof e&&(e=parseDocId(e)),r._getAttachment(e,t,n)},n.allDocs=function(e,t){if("function"==typeof e&&(t=e,e={}),"keys"in e){if("startkey"in e)return call(t,extend({reason:"Query parameter `start_key` is not compatible with multi-get"},Pouch.Errors.QUERY_PARSE_ERROR)),void 0;if("endkey"in e)return call(t,extend({reason:"Query parameter `end_key` is not compatible with multi-get"},Pouch.Errors.QUERY_PARSE_ERROR)),void 0}return r._allDocs(e,t)},n.changes=function(e){return r._changes(e)},n.close=function(e){return r._close(e)},n.info=function(e){return r._info(e)},n.bulkDocs=function(e,t,n){return"function"==typeof t&&(n=t,t={}),t||(t={}),!e||!e.docs||1>e.docs.length?call(n,Pouch.Errors.MISSING_BULK_DOCS):Array.isArray(e.docs)?r._bulkDocs(e,t,n):call(n,Pouch.Errors.QUERY_PARSE_ERROR)},n.replicate={},n.replicate.from=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(e,r,t,n)},n.replicate.to=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(r,e,t,n)};for(var o in n)r.hasOwnProperty(o)||(r[o]=n[o]);return r};"undefined"!=typeof module&&module.exports&&(module.exports=PouchAdapter);var HTTP_TIMEOUT=1e4;parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var HttpPouch=function(e,t){var n=getHost(e.name);e.auth&&(n.auth=e.auth);var r=genDBUrl(n,""),o={},a={list:[],get:function(e,t){"function"==typeof e&&(t=e,e={count:10});var r=function(e,n){!e&&"uuids"in n?(a.list=a.list.concat(n.uuids),call(t,null,"OK")):call(t,e||Pouch.Errors.UNKNOWN_ERROR)},o="?count="+e.count;ajax({auth:n.auth,method:"GET",url:genUrl(n,"_uuids")+o},r)}},i=function(){ajax({auth:n.auth,method:"PUT",url:r},function(e){e&&401===e.status?ajax({auth:n.auth,method:"HEAD",url:r},function(e){e?call(t,e):call(t,null,o)}):e&&412!==e.status?call(t,Pouch.Errors.UNKNOWN_ERROR):call(t,null,o)})};return e.skipSetup||ajax({auth:n.auth,method:"GET",url:r},function(e){e?404===e.status?i():call(t,e):call(t,null,o)}),o.type=function(){return"http"},o.id=function(){return genDBUrl(n,"")},o.request=function(e,t){e.auth=n.auth,e.url=genDBUrl(n,e.url),ajax(e,t)},o.compact=function(e){ajax({auth:n.auth,url:genDBUrl(n,"_compact"),method:"POST"},e)},o.info=function(e){ajax({auth:n.auth,method:"GET",url:genDBUrl(n,"")},e)},o.get=function(e,t,r){"function"==typeof t&&(r=t,t={});var o=[];t.revs&&o.push("revs=true"),t.revs_info&&o.push("revs_info=true"),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),o.push("open_revs="+t.open_revs)),t.attachments&&o.push("attachments=true"),t.rev&&o.push("rev="+t.rev),t.conflicts&&o.push("conflicts="+t.conflicts),o=o.join("&"),o=""===o?"":"?"+o;var a={auth:n.auth,method:"GET",url:genDBUrl(n,e+o)},i=e.split("/");(i.length>1&&"_design"!==i[0]&&"_local"!==i[0]||i.length>2&&"_design"===i[0]&&"_local"!==i[0])&&(a.json=!1),ajax(a,function(e,t,n){return e?call(r,Pouch.Errors.MISSING_DOC):(call(r,null,t,n),void 0)})},o.remove=function(e,t,r){"function"==typeof t&&(r=t,t={}),ajax({auth:n.auth,method:"DELETE",url:genDBUrl(n,e._id)+"?rev="+e._rev},r)},o.removeAttachment=function(e,t,r){ajax({auth:n.auth,method:"DELETE",url:genDBUrl(n,e)+"?rev="+t},r)},o.putAttachment=function(e,t,r,o,a){ajax({auth:n.auth,method:"PUT",url:genDBUrl(n,e)+"?rev="+t,headers:{"Content-Type":o},body:r},a)},o.put=function(e,t,r){if("function"==typeof t&&(r=t,t={}),!(e&&"_id"in e))return call(r,Pouch.Errors.MISSING_ID);var o=[];t&&t.new_edits!==void 0&&o.push("new_edits="+t.new_edits),o=o.join("&"),""!==o&&(o="?"+o),ajax({auth:n.auth,method:"PUT",url:genDBUrl(n,e._id)+o,body:e},r)},o.post=function(e,t,n){"function"==typeof t&&(n=t,t={}),"_id"in e?o.put(e,t,n):a.list.length>0?(e._id=a.list.pop(),o.put(e,t,n)):a.get(function(r){return r?call(n,Pouch.Errors.UNKNOWN_ERROR):(e._id=a.list.pop(),o.put(e,t,n),void 0)})},o.bulkDocs=function(e,t,r){"function"==typeof t&&(r=t,t={}),t||(t={}),t.new_edits!==void 0&&(e.new_edits=t.new_edits),ajax({auth:n.auth,method:"POST",url:genDBUrl(n,"_bulk_docs"),body:e},r)},o.allDocs=function(e,t){"function"==typeof e&&(t=e,e={});var r,o=[],a="GET";e.conflicts&&o.push("conflicts=true"),e.descending&&o.push("descending=true"),e.include_docs&&o.push("include_docs=true"),e.startkey&&o.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&o.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),o=o.join("&"),""!==o&&(o="?"+o),e.keys!==void 0&&(a="POST",r=JSON.stringify({keys:e.keys})),ajax({auth:n.auth,method:a,url:genDBUrl(n,"_all_docs"+o),body:r},t)},o.changes=function(e){Pouch.DEBUG&&console.log(r+": Start Changes Feed: continuous="+e.continuous);var t,o=[];if(e.style&&o.push("style="+e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&o.push("include_docs=true"),e.continuous&&o.push("feed=longpoll"),e.conflicts&&o.push("conflicts=true"),e.descending&&o.push("descending=true"),e.filter&&"string"==typeof e.filter&&o.push("filter="+e.filter),e.query_params&&"object"==typeof e.query_params)for(var a in e.query_params)e.query_params.hasOwnProperty(a)&&o.push(a+"="+e.query_params[a]);t="?",o.length>0&&(t+=o.join("&"));var i,s,c=function(r,o){var a={auth:n.auth,method:"GET",url:genDBUrl(n,"_changes"+t+"&since="+r),timeout:null};s=r,e.aborted||(i=ajax(a,o))},u=10,l=0,d=function(t,n){if(n&&n.results&&n.results.forEach(function(t){var n=e.filter&&"function"==typeof e.filter;e.aborted||n&&!e.filter.apply(this,[t.doc])||call(e.onChange,t)}),n&&n.last_seq&&(s=n.last_seq),e.continuous){t?l+=1:l=0;var r=1<<l,o=u*r,a=e.maximumWait||3e4;o>a&&call(e.complete,t||Pouch.Errors.UNKNOWN_ERROR,null),setTimeout(function(){c(s,d)},o)}else call(e.complete,null,n)};return c(e.since||0,d),{cancel:function(){Pouch.DEBUG&&console.log(r+": Cancel Changes Feed"),e.aborted=!0,i.abort()}}},o.revsDiff=function(e,t,r){"function"==typeof t&&(r=t,t={}),ajax({auth:n.auth,method:"POST",url:genDBUrl(n,"_revs_diff"),body:e},function(e,t){call(r,null,t)})},o.close=function(e){call(e,null)},o};if(HttpPouch.destroy=function(e,t){var n=getHost(e);ajax({auth:n.auth,method:"DELETE",url:genDBUrl(n,"")},t)},HttpPouch.valid=function(){return!0},"undefined"!=typeof module&&module.exports){var pouchdir="../";Pouch=require(pouchdir+"pouch.js"),ajax=Pouch.utils.ajax}Pouch.adapter("http",HttpPouch),Pouch.adapter("https",HttpPouch),window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB,window.IDBTransaction=window.IDBTransaction&&window.IDBTransaction.READ_WRITE?window.IDBTransaction:window.webkitIDBTransaction&&window.webkitIDBTransaction.READ_WRITE?window.webkitIDBTransaction:{READ_WRITE:"readwrite"},window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,window.storageInfo=window.storageInfo||window.webkitStorageInfo,window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;var idbError=function(e){return function(t){call(e,{status:500,error:t.type,reason:t.target})}},IdbPouch=function(opts,callback){function sortByBulkSeq(e,t){return e._bulk_seq-t._bulk_seq}var POUCH_VERSION=1,DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACH_STORE="attach-store",META_STORE="meta-store",name=opts.name,req=indexedDB.open(name,POUCH_VERSION),meta={id:"meta-store",updateSeq:0},instanceId=null,api={},idb=null;return Pouch.DEBUG&&console.log(name+": Open Database"),req.onupgradeneeded=function(e){var t=e.target.result;t.createObjectStore(DOC_STORE,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),t.createObjectStore(BY_SEQ_STORE,{autoIncrement:!0}).createIndex("_rev","_rev",{unique:!0}),t.createObjectStore(ATTACH_STORE,{keyPath:"digest"}),t.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:!1})},req.onsuccess=function(e){idb=e.target.result;var t=idb.transaction([META_STORE],IDBTransaction.READ_WRITE);if(idb.onversionchange=function(){idb.close()},idb.setVersion&&Number(idb.version)!==POUCH_VERSION){var n=idb.setVersion(POUCH_VERSION);return n.onsuccess=function(t){function n(){r.onsuccess(e)}t.target.result.oncomplete=n,r.onupgradeneeded(e)},void 0}var r=t.objectStore(META_STORE).get("meta-store");r.onsuccess=function(e){var n;e.target.result&&(meta=e.target.result),name+"_id"in meta?instanceId=meta[name+"_id"]:(instanceId=Math.uuid(),meta[name+"_id"]=instanceId,n=t.objectStore(META_STORE).put(meta)),call(callback,null,api)
}},req.onerror=idbError(callback),api.type=function(){return"idb"},api.id=function idb_id(){return instanceId},api._bulkDocs=function idb_bulkDocs(e,t,n){function r(){if(_.length){var e=_.shift(),t=v.objectStore(DOC_STORE).get(e.metadata.id);t.onsuccess=function(t){var n=t.target.result;n?i(n,e):s(e)}}}function o(){var e=[];h.sort(sortByBulkSeq),h.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,r=Pouch.merge.winningRev(n);e.push({ok:!0,id:n.id,rev:r}),isLocalId(n.id)||(IdbPouch.Changes.notify(name),localStorage[name]="a"===localStorage[name]?"b":"a")}),call(n,null,e)}function a(e,t){function n(e){o||(e?(o=e,call(t,o)):a==i.length&&r())}function r(){var n=v.objectStore(BY_SEQ_STORE).put(e.data);n.onsuccess=function(n){Pouch.DEBUG&&console.log(name+": Wrote Document ",e.metadata.id),e.metadata.seq=n.target.result,delete e.metadata.rev;var r=v.objectStore(DOC_STORE).put(e.metadata);r.onsuccess=function(){h.push(e),call(t)}}}var o=null,a=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,meta.updateSeq++,v.objectStore(META_STORE).put(meta),isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var i=e.data._attachments?Object.keys(e.data._attachments):[];for(var s in e.data._attachments)if(e.data._attachments[s].stub)a++,n();else{var c=e.data._attachments[s].data,l="md5-"+Crypto.MD5(c);delete e.data._attachments[s].data,e.data._attachments[s].digest=l,u(e,l,c,function(e){a++,n(e)})}i.length||r()}function i(e,t){t.metadata.deletions=extend(t.metadata.deletions,e.deletions);var n=Pouch.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),o=isDeleted(e)&&isDeleted(t.metadata)||!isDeleted(e)&&l&&"new_leaf"!==n.conflicts;return o?(h.push(c(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),r()):(t.metadata.rev_tree=n.tree,a(t,r),void 0)}function s(e){return"was_delete"in t&&isDeleted(e.metadata)?(h.push(Pouch.Errors.MISSING_DOC),r()):(a(e,r),void 0)}function c(e,t){return e._bulk_seq=t,e}function u(e,t,n,r){var o=v.objectStore(ATTACH_STORE),a=o.get(t).onsuccess=function(a){var i=[e.metadata.id,e.metadata.rev].join("@"),s={digest:t,body:n};a.target.result?a.target.result.refs&&(s.refs=a.target.result.refs,s.refs[i]=!0):(s.refs={},s.refs[i]=!0);var c=o.put(s).onsuccess=function(){call(r)};c.onerror=c.ontimeout=idbError(r)};a.onerror=a.ontimeout=idbError(r)}var l="new_edits"in t?t.new_edits:!0,d=extend(!0,[],e.docs),f=d.map(function(e,t){var n=parseDoc(e,l);return n._bulk_seq=t,e._deleted&&(n.metadata.deletions||(n.metadata.deletions={}),n.metadata.deletions[e._rev.split("-")[1]]=!0),n}),p=f.filter(function(e){return e.error});if(p.length)return call(n,p[0]);var h=[],_=[];f.forEach(function(e){return e.error?h.push(e):_.length&&e.metadata.id===_[0].metadata.id?(h.push(c(Pouch.Errors.REV_CONFLICT,e._bulk_seq)),void 0):_.unshift(e)});var v=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE],IDBTransaction.READ_WRITE);v.onerror=idbError(n),v.ontimeout=idbError(n),v.oncomplete=o,r()},api._get=function idb_get(e,t,n){function r(){"error"in o?call(n,o):call(n,null,o)}var o,a=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");a.oncomplete=function(){if(i){o=[];var t=i.length;i.forEach(function(n){api.get(e.docId,{rev:n},function(e,a){e?o.push({missing:n}):o.push({ok:a}),t--,t||r()})})}else r()};var i;a.objectStore(DOC_STORE).get(e.docId).onsuccess=function(e){var n=e.target.result;if(!e.target.result||isDeleted(n,t.rev)&&!t.rev)return o=Pouch.Errors.MISSING_DOC,void 0;if(t.open_revs)return i="all"===t.open_revs?collectLeaves(n.rev_tree).map(function(e){return e.rev}):t.open_revs,void 0;var r=Pouch.merge.winningRev(n),s=t.rev?t.rev:r,c=a.objectStore(BY_SEQ_STORE).index("_rev");c.get(s).onsuccess=function(e){var r=e.target.result;if(!r)return o=Pouch.Errors.MISSING_DOC,void 0;if(t.revs){var i=arrayFirst(rootToLeaf(n.rev_tree),function(e){return-1!==e.ids.indexOf(r._rev.split("-")[1])});i.ids.reverse(),r._revisions={start:i.pos+i.ids.length-1,ids:i.ids}}if(t.revs_info&&(r._revs_info=n.rev_tree.reduce(function(e,t){return e.concat(collectRevs(t))},[])),t.conflicts){var s=collectConflicts(n.rev_tree,n.deletions);s.length&&(r._conflicts=s)}if(t.attachments&&r._attachments){var c=Object.keys(r._attachments),u=0;c.forEach(function(e){api.getAttachment(r._id+"/"+e,{txn:a},function(t,n){r._attachments[e].data=n,++u===c.length&&(o=r)})})}else{if(r._attachments)for(var l in r._attachments)r._attachments[l].stub=!0;o=r}}}},api._getAttachment=function(e,t,n){var r,o;"txn"in t?o=t.txn:(o=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly"),o.oncomplete=function(){call(n,null,r)}),o.objectStore(DOC_STORE).get(e.docId).onsuccess=function(a){var i=a.target.result,s=o.objectStore(BY_SEQ_STORE);s.get(i.seq).onsuccess=function(a){function i(e){return t.decode&&(e=atob(e)),e}var s=a.target.result._attachments[e.attachmentId],c=s.digest;s.content_type,o.objectStore(ATTACH_STORE).get(c).onsuccess=function(e){var o=e.target.result.body;r=i(o),"txn"in t&&call(n,null,r)}}}},api._allDocs=function idb_allDocs(e,t){var n="startkey"in e?e.startkey:!1,r="endkey"in e?e.endkey:!1,o="descending"in e?e.descending:!1;o=o?"prev":null;var a=n&&r?IDBKeyRange.bound(n,r):n?IDBKeyRange.lowerBound(n):r?IDBKeyRange.upperBound(r):null,i=idb.transaction([DOC_STORE,BY_SEQ_STORE],"readonly");i.oncomplete=function(){"keys"in e&&(e.keys.forEach(function(e){e in l?u.push(l[e]):u.push({key:e,error:"not_found"})}),e.descending&&u.reverse()),call(t,null,{total_rows:u.length,rows:u})};var s=i.objectStore(DOC_STORE),c=o?s.openCursor(a,o):s.openCursor(a),u=[],l={};c.onsuccess=function(t){function n(t,n){if(isLocalId(t.id))return r["continue"]();var o={id:t.id,key:t.id,value:{rev:Pouch.merge.winningRev(t)}};e.include_docs&&(o.doc=n,o.doc._rev=Pouch.merge.winningRev(t),e.conflicts&&(o.doc._conflicts=collectConflicts(t.rev_tree,t.deletions))),"keys"in e?e.keys.indexOf(t.id)>-1&&(isDeleted(t)&&(o.value.deleted=!0,o.doc=null),l[o.id]=o):isDeleted(t)||u.push(o),r["continue"]()}if(t.target.result){var r=t.target.result;if(e.include_docs){var o=i.objectStore(BY_SEQ_STORE);o.get(r.value.seq).onsuccess=function(e){n(r.value,e.target.result)}}else n(r.value)}}},api._info=function idb_info(e){var t,n=0,r=idb.transaction([DOC_STORE],"readonly");r.oncomplete=function(){e(null,t)},r.objectStore(DOC_STORE).openCursor().onsuccess=function(e){var r=e.target.result;return r?(r.value.deleted!==!0&&n++,r["continue"](),void 0):(t={db_name:name,doc_count:n,update_seq:meta.updateSeq},void 0)}},api._changes=function idb_changes(opts){function fetchChanges(){txn=idb.transaction([DOC_STORE,BY_SEQ_STORE]),txn.oncomplete=onTxnComplete;var e=descending?txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.since,!0),descending):txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.since,!0));e.onsuccess=onsuccess,e.onerror=onerror}function onsuccess(e){if(!e.target.result){opts.continuous&&!opts.cancelled&&IdbPouch.Changes.addListener(name,id,api,opts);for(var t=0,n=results.length;n>t;t++){var r=results[t];r&&dedupResults.push(r)}return!1}var o=e.target.result,a=o.value._id,i=resultIndices[a];if(void 0!==i)return results[i].seq=o.key,results.push(results[i]),results[i]=null,resultIndices[a]=results.length-1,o["continue"]();var s=txn.objectStore(DOC_STORE);s.get(o.value._id).onsuccess=function(e){var t=e.target.result;if(isLocalId(t.id))return o["continue"]();var n=Pouch.merge.winningRev(t),r=txn.objectStore(BY_SEQ_STORE).index("_rev");r.get(n).onsuccess=function(e){var r=e.target.result,a=[{rev:n}];"all_docs"===opts.style&&(a=collectLeaves(t.rev_tree));var i={id:t.id,seq:o.key,changes:a,doc:r};isDeleted(t,n)&&(i.deleted=!0),opts.conflicts&&(i.doc._conflicts=collectConflicts(t.rev_tree,t.deletions));var s=i.id,c=resultIndices[s];void 0!==c&&(results[c]=null),results.push(i),resultIndices[s]=results.length-1,o["continue"]()}}}function onTxnComplete(){dedupResults.map(function(e){(!opts.filter||opts.filter.apply(this,[e.doc]))&&(opts.include_docs||delete e.doc,e.seq>opts.since&&(opts.since=e.seq,call(opts.onChange,e)))}),(!opts.continuous||opts.continuous&&!opts.cancelled)&&call(opts.complete,null,{results:dedupResults})}function onerror(){opts.continuous&&!opts.cancelled?IdbPouch.Changes.addListener(name,id,opts):call(opts.complete)}Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous);var descending="descending"in opts?opts.descending:!1;descending=descending?"prev":null,opts.since=opts.since&&!descending?opts.since:0;var results=[],resultIndices={},dedupResults=[],id=name+":"+Math.uuid(),txn;if(opts.filter&&"string"==typeof opts.filter){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges();return opts.continuous?{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,IdbPouch.Changes.removeListener(name,id)}}:void 0},api._close=function(e){return null===idb?call(e,Pouch.Errors.NOT_OPEN):(idb.close(),call(e,null),void 0)},api};IdbPouch.valid=function idb_valid(){return document.location.host||console.error("indexedDB cannot be used in pages served from the filesystem"),!!window.indexedDB&&!!document.location.host},IdbPouch.destroy=function idb_destroy(e,t){Pouch.DEBUG&&console.log(e+": Delete Database"),IdbPouch.Changes.clearListeners(e);var n=indexedDB.deleteDatabase(e);n.onsuccess=function(){call(t,null)},n.onerror=idbError(t)},IdbPouch.Changes=Changes(),Pouch.adapter("idb",IdbPouch);var POUCH_VERSION=1,POUCH_SIZE=5242880,DOC_STORE=quote("document-store"),BY_SEQ_STORE=quote("by-sequence"),ATTACH_STORE=quote("attach-store"),META_STORE=quote("metadata-store"),unknownError=function(e){return function(t){call(e,{status:500,error:t.type,reason:t.target})}},webSqlPouch=function(opts,callback){function dbCreated(){callback(null,api)}var api={},update_seq=0,name=opts.name,db=openDatabase(name,POUCH_VERSION,name,POUCH_SIZE);return db?(db.transaction(function(e){var t="CREATE TABLE IF NOT EXISTS "+META_STORE+" (update_seq)",n="CREATE TABLE IF NOT EXISTS "+ATTACH_STORE+" (digest, json)",r="CREATE TABLE IF NOT EXISTS "+DOC_STORE+" (id unique, seq, json, winningseq)",o="CREATE TABLE IF NOT EXISTS "+BY_SEQ_STORE+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, rev UNIQUE, json)";e.executeSql(n),e.executeSql(r),e.executeSql(o),e.executeSql(t);var a="SELECT update_seq FROM "+META_STORE;e.executeSql(a,[],function(e,t){if(!t.rows.length){var n="INSERT INTO "+META_STORE+" (update_seq) VALUES (?)";return e.executeSql(n,[0]),void 0}update_seq=t.rows.item(0).update_seq})},unknownError(callback),dbCreated),api.type=function(){return"websql"},api.id=function(){var e=localJSON.get(name+"_id",null);return null===e&&(e=Math.uuid(),localJSON.set(name+"_id",e)),e},api._info=function(e){db.transaction(function(t){var n="SELECT COUNT(id) AS count FROM "+DOC_STORE;t.executeSql(n,[],function(t,n){e(null,{db_name:name,doc_count:n.rows.item(0).count,update_seq:update_seq})})})},api._bulkDocs=function idb_bulkDocs(e,t,n){function r(e,t){return e._bulk_seq-t._bulk_seq}function o(){var e=[];m.sort(r),m.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,r=Pouch.merge.winningRev(n);if(e.push({ok:!0,id:n.id,rev:r}),!isLocalId(n.id)){update_seq++;var o="UPDATE "+META_STORE+" SET update_seq=?";v.executeSql(o,[update_seq],function(){webSqlPouch.Changes.notify(name),localStorage[name]="a"===localStorage[name]?"b":"a"})}}),call(n,null,e)}function a(e,t,n){function r(e){i||(e?(i=e,call(t,i)):s==c.length&&a())}function o(r,o){var a=e.metadata.seq=o.insertId;delete e.metadata.rev;var i=Pouch.merge.winningRev(e.metadata),s=n?"UPDATE "+DOC_STORE+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+BY_SEQ_STORE+" WHERE rev=?) WHERE id=?":"INSERT INTO "+DOC_STORE+" (id, seq, winningseq, json) VALUES (?, ?, ?, ?);",c=n?[a,JSON.stringify(e.metadata),i,e.metadata.id]:[e.metadata.id,a,a,JSON.stringify(e.metadata)];r.executeSql(s,c,function(){m.push(e),call(t,null)})}function a(){var t=e.data,n="INSERT INTO "+BY_SEQ_STORE+" (rev, json) VALUES (?, ?);";v.executeSql(n,[t._rev,JSON.stringify(t)],o)}var i=null,s=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var c=e.data._attachments?Object.keys(e.data._attachments):[];for(var u in e.data._attachments)if(e.data._attachments[u].stub)s++,r();else{var d=e.data._attachments[u].data,f="md5-"+Crypto.MD5(d);delete e.data._attachments[u].data,e.data._attachments[u].digest=f,l(e,f,d,function(e){s++,r(e)})}c.length||a()}function i(e,t){t.metadata.deletions=extend(t.metadata.deletions,e.deletions);var n=Pouch.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=isDeleted(e)&&isDeleted(t.metadata)||!isDeleted(e)&&f&&"new_leaf"!==n.conflicts;return r?(m.push(u(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),c()):(t.metadata.rev_tree=n.tree,a(t,c,!0),void 0)}function s(e){return"was_delete"in t&&isDeleted(e.metadata)?(m.push(Pouch.Errors.MISSING_DOC),c()):(a(e,c,!1),void 0)}function c(){if(!g.length)return o();var e=g.shift(),t=e.metadata.id;t in E?i(E[t],e):s(e)}function u(e,t){return e._bulk_seq=t,e}function l(e,t,n,r){var o=[e.metadata.id,e.metadata.rev].join("@"),a={digest:t,body:n},i="SELECT * FROM "+ATTACH_STORE+" WHERE digest=?";v.executeSql(i,[t],function(e,n){n.rows.length?(a.refs=JSON.parse(n.rows.item(0).json).refs,i="UPDATE "+ATTACH_STORE+" SET json=? WHERE digest=?",e.executeSql(i,[JSON.stringify(a),t],function(){call(r,null)})):(a.refs={},a.refs[o]=!0,i="INSERT INTO "+ATTACH_STORE+"(digest, json) VALUES (?, ?)",e.executeSql(i,[t,JSON.stringify(a)],function(){call(r,null)}))})}function d(e,t){for(var n=0;t.rows.length>n;n++){var r=t.rows.item(n);E[r.id]=JSON.parse(r.json)}c()}var f="new_edits"in t?t.new_edits:!0,p=extend(!0,[],e.docs),h=p.map(function(e,t){var n=parseDoc(e,f);return n._bulk_seq=t,e._deleted&&(n.metadata.deletions||(n.metadata.deletions={}),n.metadata.deletions[e._rev.split("-")[1]]=!0),n}),_=h.filter(function(e){return e.error});if(_.length)return call(n,_[0]);var v,m=[],g=[],E={};h.forEach(function(e){return e.error?m.push(e):g.length&&e.metadata.id===g[0].metadata.id?(m.push(u(Pouch.Errors.REV_CONFLICT,e._bulk_seq)),void 0):g.unshift(e)}),db.transaction(function(e){v=e;var t="("+g.map(function(e){return quote(e.metadata.id)}).join(",")+")",n="SELECT * FROM "+DOC_STORE+" WHERE id IN "+t;v.executeSql(n,[],d)},unknownError(n))},api._get=function(e,t,n){function r(){"error"in o?call(n,o):call(n,null,o)}var o,a;db.transaction(function(n){var r="SELECT * FROM "+DOC_STORE+" WHERE id=?";n.executeSql(r,[e.docId],function(e,n){if(!n.rows.length)return o=Pouch.Errors.MISSING_DOC,void 0;var r=JSON.parse(n.rows.item(0).json);if(isDeleted(r,t.rev)&&!t.rev)return o=Pouch.Errors.MISSING_DOC,void 0;if(t.open_revs)return a="all"===t.open_revs?collectLeaves(r.rev_tree).map(function(e){return e.rev}):t.open_revs,void 0;var i=Pouch.merge.winningRev(r),s=t.rev?t.rev:i,c="SELECT * FROM "+BY_SEQ_STORE+" WHERE rev=?";e.executeSql(c,[s],function(e,n){if(!n.rows.length)return o=Pouch.Errors.MISSING_DOC,void 0;var a=JSON.parse(n.rows.item(0).json);if(t.revs){var i=arrayFirst(rootToLeaf(r.rev_tree),function(e){return-1!==e.ids.indexOf(a._rev.split("-")[1])});i.ids.reverse(),a._revisions={start:i.pos+i.ids.length-1,ids:i.ids}}if(t.revs_info&&(a._revs_info=r.rev_tree.reduce(function(e,t){return e.concat(collectRevs(t))},[])),t.conflicts){var s=collectConflicts(r.rev_tree,r.deletions);s.length&&(a._conflicts=s)}if(t.attachments&&a._attachments){var c=Object.keys(a._attachments),u=0;c.forEach(function(t){api.getAttachment(a._id+"/"+t,{txn:e},function(e,n){a._attachments[t].data=n,++u===c.length&&(o=a)})})}else{if(a._attachments)for(var l in a._attachments)a._attachments[l].stub=!0;o=a}})})},unknownError(n),function(){if(a){o=[];var t=a.length;a.forEach(function(n){api.get(e.docId,{rev:n},function(e,a){e?o.push({missing:n}):o.push({ok:a}),t--,t||r()})})}else r()})},api._allDocs=function(e,t){var n=[],r={},o="startkey"in e?e.startkey:!1,a="endkey"in e?e.endkey:!1,i="descending"in e?e.descending:!1,s="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq";"keys"in e?s+=" WHERE "+DOC_STORE+".id IN ("+e.keys.map(function(e){return quote(e)}).join(",")+")":(o&&(s+=" WHERE "+DOC_STORE+'.id >= "'+o+'"'),a&&(s+=(o?" AND ":" WHERE ")+DOC_STORE+'.id <= "'+a+'"'),s+=" ORDER BY "+DOC_STORE+".id "+(i?"DESC":"ASC")),db.transaction(function(t){t.executeSql(s,[],function(t,o){for(var a=0,i=o.rows.length;i>a;a++){var s=o.rows.item(a),c=JSON.parse(s.metadata),u=JSON.parse(s.data);if(!isLocalId(c.id)){var s={id:c.id,key:c.id,value:{rev:Pouch.merge.winningRev(c)}};e.include_docs&&(s.doc=u,s.doc._rev=Pouch.merge.winningRev(c),e.conflicts&&(s.doc._conflicts=collectConflicts(c.rev_tree,c.deletions))),"keys"in e?e.keys.indexOf(c.id)>-1&&(isDeleted(c)&&(s.value.deleted=!0,s.doc=null),r[s.id]=s):isDeleted(c)||n.push(s)}}})},unknownError(t),function(){"keys"in e&&(e.keys.forEach(function(e){e in r?n.push(r[e]):n.push({key:e,error:"not_found"})}),e.descending&&n.reverse()),call(t,null,{total_rows:n.length,rows:n})})},api._changes=function idb_changes(opts){function fetchChanges(){var e="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq WHERE "+DOC_STORE+".seq > "+opts.since+" ORDER BY "+DOC_STORE+".seq "+(descending?"DESC":"ASC");db.transaction(function(t){t.executeSql(e,[],function(e,t){for(var n=0,r=t.rows.length;r>n;n++){var o=t.rows.item(n),a=JSON.parse(o.metadata);if(!isLocalId(a.id)){var i={id:a.id,seq:o.seq,changes:collectLeaves(a.rev_tree),doc:JSON.parse(o.data)};i.doc._rev=Pouch.merge.winningRev(a),isDeleted(a,i.doc._rev)&&(i.deleted=!0),opts.conflicts&&(i.doc._conflicts=collectConflicts(a.rev_tree,a.deletions)),results.push(i)}}for(var n=0,r=results.length;r>n;n++){var t=results[n];t&&dedupResults.push(t)}dedupResults.map(function(e){(!opts.filter||opts.filter.apply(this,[e.doc]))&&(opts.include_docs||delete e.doc,e.seq>opts.since&&(opts.since=e.seq,call(opts.onChange,e)))}),opts.continuous&&!opts.cancelled?webSqlPouch.Changes.addListener(name,id,api,opts):call(opts.complete,null,{results:dedupResults})})})}Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous);var descending="descending"in opts?opts.descending:!1;descending=descending?"prev":null,opts.since=opts.since&&!descending?opts.since:0;var results=[],resultIndices={},dedupResults=[],id=name+":"+Math.uuid(),txn;if(opts.filter&&"string"==typeof opts.filter){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges();return opts.continuous?{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,webSqlPouch.Changes.removeListener(name,id)}}:void 0},api._getAttachment=function(e,t,n){function r(e){return t.decode?atob(e):e}function o(o){var i="SELECT "+BY_SEQ_STORE+".json AS data FROM "+DOC_STORE+" JOIN "+BY_SEQ_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".seq WHERE "+DOC_STORE+'.id = "'+e.docId+'"';o.executeSql(i,[],function(o,i){var s=JSON.parse(i.rows.item(0).data),c=s._attachments[e.attachmentId],u=c.digest;c.content_type;var l="SELECT * FROM "+ATTACH_STORE+" WHERE digest=?";o.executeSql(l,[u],function(e,o){var i=JSON.parse(o.rows.item(0).json).body;a=r(i),"txn"in t&&call(n,null,a)})})}var a;"txn"in t?o(t.txn):db.transaction(o,unknownError(n),function(){call(n,null,a)})},api):call(callback,Pouch.Errors.UNKNOWN_ERROR)};webSqlPouch.valid=function(){return!!window.openDatabase},webSqlPouch.destroy=function(e,t){var n=openDatabase(e,POUCH_VERSION,e,POUCH_SIZE);localJSON.set(e+"_id",null),n.transaction(function(e){e.executeSql("DROP TABLE IF EXISTS "+DOC_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+BY_SEQ_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+ATTACH_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+META_STORE,[])},unknownError(t),function(){call(t,null)})},webSqlPouch.Changes=Changes(),Pouch.adapter("websql",webSqlPouch);var MapReduce=function(db){function viewQuery(fun,options){function sum(e){return e.reduce(function(e,t){return e+t},0)}if(options.complete){fun.reduce||(options.reduce=!1);var results=[],current=null,num_started=0,completed=!1,emit=function(e,t){var n={id:current.doc._id,key:e,value:t};if(!(options.startkey&&0>Pouch.collate(e,options.startkey)||options.endkey&&Pouch.collate(e,options.endkey)>0||options.key&&0!==Pouch.collate(e,options.key))){if(num_started++,options.include_docs){if(t&&"object"==typeof t&&t._id)return db.get(t._id,function(e,t){t&&(n.doc=t),results.push(n),checkComplete()}),void 0;n.doc=current.doc}results.push(n)}};eval("fun.map = "+(""+fun.map)+";"),fun.reduce&&eval("fun.reduce = "+(""+fun.reduce)+";");var conflicts="conflicts"in options?options.conflicts:!1,checkComplete=function(){if(completed&&results.length==num_started){if(results.sort(function(e,t){return Pouch.collate(e.key,t.key)}),options.descending&&results.reverse(),options.reduce===!1)return options.complete(null,{rows:results});var e=[];results.forEach(function(t){var n=e[e.length-1]||null;return n&&0===Pouch.collate(n.key[0][0],t.key)?(n.key.push([t.key,t.id]),n.value.push(t.value),void 0):(e.push({key:[[t.key,t.id]],value:[t.value]}),void 0)}),e.forEach(function(e){e.value=fun.reduce(e.key,e.value)||null,e.key=e.key[0][0]}),options.complete(null,{rows:e})}};db.changes({conflicts:conflicts,include_docs:!0,onChange:function(e){"deleted"in e||(current={doc:e.doc},fun.map.call(this,e.doc))},complete:function(){completed=!0,checkComplete()}})}}function httpQuery(e,t,n){var r=[],o=void 0,a="GET";if(t.reduce!==void 0&&r.push("reduce="+t.reduce),t.include_docs!==void 0&&r.push("include_docs="+t.include_docs),t.limit!==void 0&&r.push("limit="+t.limit),t.descending!==void 0&&r.push("descending="+t.descending),t.startkey!==void 0&&r.push("startkey="+encodeURIComponent(JSON.stringify(t.startkey))),t.endkey!==void 0&&r.push("endkey="+encodeURIComponent(JSON.stringify(t.endkey))),t.key!==void 0&&r.push("key="+encodeURIComponent(JSON.stringify(t.key))),t.keys!==void 0&&(a="POST",o=JSON.stringify({keys:t.keys})),r=r.join("&"),r=""===r?"":"?"+r,"string"==typeof e){var i=e.split("/");return db.request({method:a,url:"_design/"+i[0]+"/_view/"+i[1]+r,body:o},n),void 0}var s=JSON.parse(JSON.stringify(e,function(e,t){return"function"==typeof t?t+"":t}));db.request({method:"POST",url:"_temp_view"+r,body:s},n)}function query(e,t,n){if("function"==typeof t&&(n=t,t={}),n&&(t.complete=n),"http"===db.type())return httpQuery(e,t,n);if("object"==typeof e)return viewQuery(e,t);var r=e.split("/");db.get("_design/"+r[0],function(e,o){return e?(n&&n(e),void 0):(viewQuery({map:o.views[r[1]].map,reduce:o.views[r[1]].reduce},t),void 0)})}return{query:query}};MapReduce._delete=function(){},Pouch.plugin("mapreduce",MapReduce);