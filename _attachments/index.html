<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Metakaolin</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="d3.min.js"></script>
    <script src="d3.geo.min.js"></script>
    <script src="fermata.min.js"></script>
    <script src="polymaps.min.js"></script>
    <script src="polymaps.editor.js"></script>
    <script src="polymaps.viewer.js"></script>
    
    <style>
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
        }
        #controls {
            position: absolute;
            left: 0; right: 0;
            z-index: 1;
            height: 44px;
            font-family: "Trebuchet MS", sans-serif;
            display: -webkit-box;
            -webkit-box-orient: horizontal;
            -webkit-box-shadow: 0 1px 2px black;
            background: black;
        }
        #controls > * {
            display: block;
            line-height: 44px;
            min-width: 44px;
            color: white;
            background: grey;
            text-align: center;
            margin: 0 1px;
            padding: 0 5px;
        }
        #controls > :first-child { margin-left: 0; }
        #controls > :last-child { margin-right: 0; }
        #controls  .title {
            -webkit-box-flex: 1;
        }
        #map {
            display: block;
            position: absolute;
            top: 44px; bottom: 0px;
            left: 0; right: 0;
            overflow: hidden;       /* not sure why necessary, but otherwise simply adding svg element causes 4px body overflow */
        }
        #map svg {
            width: 100%; height: 100%;
        }
        #map .add {
            display: block;
            position: absolute;
            top: 25px; left: 5px;
            text-align: center;
            line-height: 1em; font-family: "Courier New", "Courier", monospace; font-weight: bold;
            width: 1em; height: 1em;
            border-radius: 1em;
            border: 2px solid white;
            background: black;
            color: white;
            font-size: 44px;
        }
        a {
            -webkit-user-select: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id=controls>
<a>← All</a>
<span class=title>This is the document title.</span>
<a>Edit…</a>
</div>
<div id=map>
<svg></svg>                         <!-- wrapping SVG element lets default width/height *attribute* (vs. style?) work right across browsers -->
<a class=add>+</a>
</div>
<script>
d3.selectAll('a').on('click', function () {
    d3.event.preventDefault();
    alert("You clicked \""+ this.textContent + "\"");
});
        var po = org.polymaps,
            map = po.map().container(d3.select('#map > svg').node());
        map.add(po.interact()).zoomRange([0,24]);
        
        // TODO: properly attribute whichever layer is used
        var tiles = po.image().on('load', function (e) {
            // https://github.com/simplegeo/polymaps/issues/36
            e.tile.element.width.baseVal.value += 1;
            e.tile.element.height.baseVal.value += 1;
        }).zoom(function(z) { return Math.max(0, Math.min(18, z)); });
        if (1) tiles.url(po.url("http://temp{S}.argyl.es/preview-key/{Z}/{X}/{Y}.jpg")
            .hosts([1, 2, 3]));
        else if (0) tiles.url(po.url("http://oatile{S}.mqcdn.com/naip"
            + "/{Z}/{X}/{Y}.jpg").hosts([1, 2, 3, 4]));
        else if (0) tiles.url(po.url("http://{S}tile.cloudmade.com"
            + "/51664f123b50414da85e963f92c721f0"
            + "/998/256/{Z}/{X}/{Y}.png")
            .hosts(["a.", "b.", "c.", ""]));
        else tiles.url(po.url("http://{S}tile.openstreetmap.org/{Z}/{X}/{Y}.png")
            .hosts(["a.", "b.", "c.", ""]));
        map.add(tiles);
        
        
        var vector = po_metakaolin_viewer(),
            editor = po_metakaolin_editor();
        map.add(vector).add(editor);
        
        vector.on('show', function (loadEvent) {
            loadEvent.features.forEach(function (f,i) {
                //d3.select(f.element).on('dblclick', function () {
                d3.select(f.element).on('click', function () {
                    d3.event.stopPropagation();
                    d3.event.preventDefault();
                    editGeometry(f.data.geometry);
                }).on("mouseover", function () {
                    d3.select(this).classed('hover', true);
                }).on("mouseout", function () {
                    d3.select(this).classed('hover', false);
                }).classed('color' + (i % 3), true).classed('editing', f.data.geometry === editingGeometry);
            });
        });
        
        var featureCollection = null;
        function updateFeatures() {
            //geoJsonEl.value = JSON.stringify(featureCollection);
            vector.features(featureCollection.features);
            d3.select('#doc_controls .save').property('disabled', false);
        }
        if (!featureCollection) {
            featureCollection = {type:"FeatureCollection", features:[]};
            updateFeatures();
        }
        
        if (featureCollection.features.length) {
            var bounds = d3.geo.bounds(featureCollection).map(function (c) { return {lon:c[0], lat:c[1]}; });
            vector.features(featureCollection.features);
            map.extent(bounds).zoomBy(-0.25);
        } else if (0 && navigator.geolocation) navigator.geolocation.getCurrentPosition(function (p) {
            map.center({lat:p.coords.latitude, lon:p.coords.longitude}).zoom(14);
        });
        
        d3.select('#doc_controls .add').on('click', function () {
            d3.event.preventDefault();
            addFeature();
        });
        d3.select('input[name=title]').on('change', function () {
            d3.select('#doc_controls .save').property('disabled', false);
        });
        d3.select('#doc_controls').on('submit', function () {
            d3.select('#doc_controls .save').property('disabled', true);
        });
        window.addEventListener('beforeunload', function () {
            if (d3.select('#doc_controls .save').property('disabled') === false) {
                return 'You have unsaved changes that will be lost.';
            }
        }, false);
        
        function addFeature() {
            var geom = {type:"Point", coordinates:[]},
                center = map.center();
            geom.coordinates.push(center.lon);
            geom.coordinates.push(center.lat);
            featureCollection.features.push({type:"Feature", properties:null, geometry:geom});
            updateFeatures();
            editGeometry(geom);
        }
        
        var editingGeometry = null;
        function editGeometry(geom) {
            d3.select(document.body).classed('editing_shape', true);
            editor.geometry(editingGeometry = geom);
            vector.reshow();
        }
        function saveEdits() {
            var newGeometry = editor.geometry();
            Object.keys(newGeometry).forEach(function (key) {
                editingGeometry[key] = newGeometry[key];
                if (key === "geometries") delete editingGeometry["coordinates"];
                if (key === "coordinates") delete editingGeometry["geometries"];
            });
            updateFeatures();
            finishEditing();
        }
        function deleteEdited() {
            var removedFeature = featureCollection.features.filter(function (f) { return f.geometry === editingGeometry; })[0];
            console.log(featureCollection.features.length);
            featureCollection.features = featureCollection.features.filter(function (f) { return f !== removedFeature; });
            console.log(featureCollection.features.length);
            updateFeatures();
            finishEditing();
        }
        function finishEditing() {
            editor.geometry(editingGeometry = null);
            vector.reshow();
            d3.select(document.body).classed('editing_shape', false);
        }
        d3.select('#shape_controls .cancel').on('click', function () {
            d3.event.preventDefault();
            finishEditing();
        });
        d3.select('#shape_controls .save').on('click', function () {
            d3.event.preventDefault();
            saveEdits();
        });
        d3.select('#shape_controls .delete').on('click', function () {
            d3.event.preventDefault();
            deleteEdited();
        });
</script>
</body>
</html>