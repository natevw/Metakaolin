<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Metakaolin</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="d3.min.js"></script>
    <script src="d3.geo.min.js"></script>
    <script src="fermata.min.js"></script>
    <script src="memcouch.js"></script>
    <script src="memcouch.pouchdb.js"></script>
    <script src="pouch.alpha.min.js"></script>
    <script src="polymaps.min.js"></script>
    <script src="polymaps.editor.js"></script>
    <script src="polymaps.viewer.js"></script>
    
    <style>
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
        }
        html {
            font-family: "Trebuchet MS", sans-serif;
        }
        .menuBar {
            position: absolute;
            left: 0; right: 0;
            z-index: 1;
            height: 44px;
            display: -webkit-box; display: -moz-box;
            -webkit-box-orient: horizontal; -moz-box-orient: horizontal;
            -webkit-box-shadow: 0 1px 2px black; box-shadow: 0 1px 2px black;
            background: black;
        }
        .menuBar > * {
            display: block;
            line-height: 44px;
            min-width: 44px;
            color: white;
            background: grey;
            text-align: center;
            margin: 0 1px;
            padding: 0 5px;
        }
        .menuBar > :first-child { margin-left: 0; }
        .menuBar > :last-child { margin-right: 0; }
        .menuBar > .title {
            font-size: 100%;
            font-weight: normal;
            -webkit-box-flex: 1; -moz-box-flex: 1;
        }
        a, a:visited {
            color: darkblue;
        }
        a:hover {
            color: blue;
        }
        a.action {
            -webkit-user-select: none;
            cursor: pointer;
        }
        .mainContent {
            display: block;
            position: absolute;
            top: 44px; bottom: 0px;
            left: 0; right: 0;
        }
        
        .mainContent.listView {
            overflow: auto;
        }
        .mainContent.listView ul.maps {
            padding-left: 0;
        }
        .mainContent.listView ul.maps > li {
            list-style: none;
            margin: 1em; padding: 1em;
            border: 1px solid grey;
            border-radius: 5px;
            background: #eee;
            color: black;
        }
        .mainContent.listView ul.maps > li.addMap {
            text-align: center;
            color: grey;
        }
        .mainContent.listView ul.maps > li > h2 {
            margin: 0;
            font-weight: normal;
        }
        .mainContent.listView ul.maps > li > span {
            margin: 0;
            font-size: 75%;
            font-style: italic;
        }
        .mainContent.listView ul.maps > li > .delete {
            color: darkred;
            float: right;
        }
        
        .mainContent.mapView {
            overflow: hidden;       /* not sure why necessary, but otherwise simply adding svg element causes 4px body overflow */
        }
        .mainContent.mapView > .map {
            width: 100%; height: 100%;
        }
        .mainContent.mapView > .add {
            display: block;
            position: absolute;
            top: 25px; left: 5px;
            text-align: center;
            line-height: 1em; font-family: "Courier New", "Courier", monospace; font-weight: bold;
            width: 1em; height: 1em;
            border-radius: 1em;
            border: 2px solid white;
            background: black;
            color: white;
            font-size: 44px;
        }
    </style>
</head>
<body>
<script>
function stage(container) {
    var stage = {};
    
    var root = d3.select(container).html('').classed('stage', true),
            menuBar = root.append('header').classed('menuBar', true),
                backButton = menuBar.append('a').classed('action', true).classed('back', true).text("← Back"),
                mainTitle = menuBar.append('h1').classed('title', true).classed('bar', true).text("Untitled scene"),
                menuButton = menuBar.append('a').classed('action', true).classed('menu', true).text("Edit…"),
            content = root.append('div').classed('mainContent', true);
    
    // WORKAROUND: Firefox won't display [old-style] flexbox if positioned absolute http://stackoverflow.com/a/9163605/179583
    if (~navigator.userAgent.indexOf('Firefox')) menuBar.style('position', "static").style('width', "100%");
    
    /*
    mainStage.push(function () {
        this.scene("Shapes", function (container) {
            // set up main view
            return function () {
                // tear down main view
            };
        })
        this.title(doc.title, "Zoom to extent", function () {
        
        })
        this.extra("Options", "View layer options", function () {
            
        });
    });
    */
    
    var scenes = [],
        exitPreviousView;
    function activate(scene, prev) {
        var backTitle = "Back", backTooltip = "Return to previous";
        var modifiers = {
            back: function (title, tip, action) {
                if (title) backButton.style('display', null).text("← " + title).attr('title', tip).on('click', action);
                else backButton.style('display', "none");
            },
            scene: function (nickname, view, data) {
                backTitle = nickname;
                if (exitPreviousView) exitPreviousView();
                exitPreviousView = view(content.node(), data);
            },
            title: function (title, tip, action) {
                backTooltip = "Return to " + title;
                mainTitle.text(title).attr('title', tip || null).on('click', action || null);
            },
            extra: function (title, tip, activate) {
                if (title) menuButton.style('display', null).text(title).attr('title', tip).on('click', activate);
                else menuButton.style('display', "none");
            }
        };
        modifiers.back(prev.title, prev.tooltip, stage.pop);
        modifiers.scene("Back", function () {});
        modifiers.title("Return to previous");
        modifiers.extra(null);
        scene.call(modifiers);
        return {title:backTitle, tooltip:backTooltip};
    }
    stage.push = function (scene) {
        var prev = scenes[scenes.length - 1],
            sceneInfo = activate(scene, prev || {});
        sceneInfo.scene = scene;
        scenes.push(sceneInfo);
    };
    stage.pop = function () {
        scenes.pop();
        var scene = scenes[scenes.length - 1].scene,
            prev = scenes[scenes.length - 2],
            sceneInfo = activate(scene, prev || {});
        sceneInfo.scene = scene;
        scenes[scenes.length - 1] = sceneInfo;
    };
    return stage;
};


var model = memcouch.db();
Pouch("idb://metakaolin", function (e,db) {
    if (e) throw e;
    dbgDB = db;
    
    var status = memcouch.slaveToPouch(model, db);
    window.addEventListener('beforeunload', function () {
        if (status.changesPending) return (e.returnValue = "Not all of your changes have been saved to disk yet, please wait!");
    }, false);
    
    // TODO: move this to visible, app-level configuration when integrating back into CouchDB
    if (0 && location.protocol !== 'file:') {
        var ddocIdx = location.href.indexOf("/_design/"),
            ddocName = location.href.slice(ddocIdx).split('/')[2],
            dbURL = (~ddocIdx) ? location.href.slice(0, ddocIdx) : "";     // if no ddoc in URL, just try root I guess?
        Pouch.replicate(dbURL, db, {continuous:false, filter:ddocName+"/geodocs"});
        Pouch.replicate(db, dbURL, {continuous:true});
    }
});

var mainStage = stage(document.body);
mainStage.push(function () {
    this.scene("Maps", listView);
    this.title("All maps");
});

function listView(container) {
    var root = d3.select(container).html('').classed('listView', true),
            list = root.append('ul').classed('maps', true),
                addMap = list.append('li').classed('addMap', true).append('h2').append('a').classed('action', true).text("New map…");
    
    function openDocument(doc) {
        mainStage.push(function () {
            this.scene("Features", mapView, doc);
            this.title(doc.title);
        });
    }
    
    addMap.attr('href', "#").on('click', function () {
        d3.event.preventDefault();
        var doc = {
            'com.stemstorage.geodoc':true,
            _id: 'geodoc-' + memcouch.id(),
            content: {type:"FeatureCollection", features:[]},
            created: new Date().toISOString(),
            title: "Untitled map"
        };
        doc.last_modified = new Date().toISOString();
        model.put(doc);
        openDocument(doc);
    });
    
    function updateList() {
        var data = model.query(function (doc) {
            if (doc['com.stemstorage.geodoc']) this.emit(doc.last_modified);
        }, true).map(function (row) { return row.doc; }).reverse();
        
        var mapItems = list.selectAll('li:not(.addMap)').data(data, function (d) { return d._id; }),
            mapItemsEnter = mapItems.enter().insert('li', ".addMap");
        mapItemsEnter.append('h2').append('a');
        mapItemsEnter.append('span');
        mapItemsEnter.append('a').classed('action', true).classed('delete', true).text("Delete?");
        mapItems.select('h2 > a').text(function (d) { return d.title; }).attr('href', function (d) { return "#" + d._id; }).on('click', function (d) {
            d3.event.preventDefault();
            openDocument(d);
        });
        mapItems.select('span').text(function (d) { return d.last_modified; });
        mapItemsEnter.select('.delete').on('click', function (d) {
            var really = confirm("This document will be almost permanently deleted.");
            if (!really) return;
            model.del(d._id);
            
        });
        mapItems.exit().remove();
        //mapItems.order();
    }
    model.watch(updateList);
    updateList();
    
    return function () {
        root.classed('listView', false);
        model.clear(updateList);
    };
}

function mapView(container, doc) {
    var root = d3.select(container).html('').classed('mapView', true),
            map = root.append('svg:svg'),
            addButton = root.append('a').classed('action', true).classed('add', true).text("+");
    
    var po = org.polymaps,
        map = po.map().container(map.node());
    map.add(po.interact()).zoomRange([0,24]);
        // TODO: properly attribute whichever layer is used
    var tiles = po.image().on('load', function (e) {
        // https://github.com/simplegeo/polymaps/issues/36
        e.tile.element.width.baseVal.value += 1;
        e.tile.element.height.baseVal.value += 1;
    }).zoom(function(z) { return Math.max(0, Math.min(18, z)); });
    if (1) tiles.url(po.url("http://temp{S}.argyl.es/preview-key/{Z}/{X}/{Y}.jpg")
        .hosts([1, 2, 3]));
    else if (0) tiles.url(po.url("http://oatile{S}.mqcdn.com/naip"
        + "/{Z}/{X}/{Y}.jpg").hosts([1, 2, 3, 4]));
    else if (0) tiles.url(po.url("http://{S}tile.cloudmade.com"
        + "/51664f123b50414da85e963f92c721f0"
        + "/998/256/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""]));
    else tiles.url(po.url("http://{S}tile.openstreetmap.org/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""]));
    map.add(tiles);
    
    var vector = po_metakaolin_viewer(),
        editor = po_metakaolin_editor();
    vector.on('show', function (loadEvent) {
        if (loadEvent.features) loadEvent.features.forEach(function (f,i) {
            d3.select(f.element).on('click', function () {
                d3.event.stopPropagation();
                d3.event.preventDefault();
                editFeature(f.data);
            }).on("mouseover", function () {
                d3.select(this).classed('hover', true);
            }).on("mouseout", function () {
                d3.select(this).classed('hover', false);
            }).classed('color' + (i % 3), true);
        });
    }).features(doc.content.features);
    map.add(vector).add(editor);
    
    addButton.on('click', function () {
        d3.event.preventDefault();
        addFeature();
    });
    
    function zoomToDoc() {
        var bounds = d3.geo.bounds(doc.content).map(function (c) { return {lon:c[0], lat:c[1]}; });
        map.extent(bounds).zoomBy(-0.25);
    }
    zoomToDoc();
    
    function addFeature() {
        var geom = {type:"Point", coordinates:[]},
            center = map.center();
        geom.coordinates.push(center.lon);
        geom.coordinates.push(center.lat);
        featureCollection.features.push({type:"Feature", properties:null, geometry:geom});
        updateFeatures();
        editGeometry(geom);
    }
    
    function editFeature(feature) {
        function zoomToFeature() {
            var bounds = d3.geo.bounds(feature).map(function (c) { return {lon:c[0], lat:c[1]}; });
            map.extent(bounds).zoomBy(-0.25);
        }
        mainStage.push(function () {
            this.scene("Edit", shapeView, {map:map, layer:editor, geometry:feature.geometry});
            this.title("Editing shape", "Zoom map to fit shape", zoomToFeature);
            zoomToFeature();
        });
    }
    
    return function () {
        model.put(doc);
        root.classed('mapView', false);
    };
}


function shapeView(container, ctx) {
    var root = d3.select(container)/*.html('')*/.classed('mapView', true);      // assume container is shared and just use existing map
    
    ctx.layer.geometry(ctx.geometry);
    
    return function () {
        var editor = ctx.layer,
            newGeometry = editor.geometry(),
            editingGeometry = ctx.geometry;
        Object.keys(newGeometry).forEach(function (key) {
            editingGeometry[key] = newGeometry[key];
            if (key === "geometries") delete editingGeometry["coordinates"];
            if (key === "coordinates") delete editingGeometry["geometries"];
        });
        editor.geometry(null);
        root.classed('mapView', false);
    }
}

</script>
</body>
</html>